{% extends 'base.html' %}

{% block title %}Dashboard - Kişisel Muhasebe{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Finansal durumunuza genel bakış{% endblock %}

{% block header_actions %}
<a href="{{ url_for('gelirler.ekle') }}" class="btn btn-primary">
    <i class="fas fa-plus"></i> Gelir Ekle
</a>
<a href="{{ url_for('giderler.ekle') }}" class="btn btn-danger">
    <i class="fas fa-minus"></i> Gider Ekle
</a>
{% endblock %}

{% block extra_css %}
<style>
    /* Tarih & Saat Kartı */
    .datetime-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 1.25rem 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid var(--gray-100);
    }
    
    .datetime-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-100);
    }
    
    .datetime-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    
    .datetime-info .time {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-800);
        letter-spacing: 0.02em;
    }
    
    .datetime-info .date {
        font-size: 0.85rem;
        color: var(--gray-500);
        margin-top: 0.15rem;
    }
    
    .timezone-select-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        position: relative;
    }
    
    .timezone-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    
    .timezone-trigger {
        width: 100%;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        background: var(--gray-50);
        color: var(--gray-700);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        position: relative;
    }
    
    .timezone-trigger::after {
        content: '\f107';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        transition: transform 0.2s ease;
    }
    
    .timezone-trigger.open::after {
        transform: translateY(-50%) rotate(180deg);
    }
    
    .timezone-trigger:hover {
        border-color: var(--primary-300);
        background: white;
    }
    
    .timezone-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 0.25rem;
        background: white;
        border: 2px solid var(--primary-300);
        border-radius: 8px;
        z-index: 100;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        overflow: hidden;
    }
    
    .timezone-dropdown.active {
        display: block;
    }
    
    .timezone-search-box {
        padding: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
    }
    
    .timezone-search {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2rem;
        border: 2px solid var(--gray-200);
        border-radius: 6px;
        background: white;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }
    
    .timezone-search:focus {
        outline: none;
        border-color: var(--primary-500);
    }
    
    .timezone-search-box {
        position: relative;
    }
    
    .timezone-search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 0.75rem;
    }
    
    .timezone-list {
        max-height: 180px;
        overflow-y: auto;
    }
    
    .timezone-group-label {
        padding: 0.4rem 0.75rem;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--gray-400);
        background: var(--gray-50);
        position: sticky;
        top: 0;
    }
    
    .timezone-option {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.15s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .timezone-option:hover {
        background: var(--primary-50);
    }
    
    .timezone-option.selected {
        background: var(--primary-100);
        color: var(--primary-700);
        font-weight: 600;
    }
    
    .timezone-option .offset {
        margin-left: auto;
        font-size: 0.7rem;
        color: var(--gray-400);
        font-family: 'JetBrains Mono', monospace;
    }
    
    .no-results {
        padding: 1rem;
        text-align: center;
        color: var(--gray-400);
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- İstatistik Kartları -->
<div class="dashboard-stats" id="statsContainer">
    <div class="stat-card gelir fade-in">
        <div class="stat-icon green">
            <i class="fas fa-arrow-trend-up"></i>
        </div>
        <div class="stat-content">
            <h3 id="aylikGelir">0,00 ₺</h3>
            <p>Bu Ay Gelir</p>
        </div>
    </div>
    
    <div class="stat-card gider fade-in" style="animation-delay: 0.1s;">
        <div class="stat-icon red">
            <i class="fas fa-arrow-trend-down"></i>
        </div>
        <div class="stat-content">
            <h3 id="aylikGider">0,00 ₺</h3>
            <p>Bu Ay Gider</p>
        </div>
    </div>
    
    <div class="stat-card bakiye fade-in" style="animation-delay: 0.2s;">
        <div class="stat-icon blue">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-content">
            <h3 id="aylikBakiye">0,00 ₺</h3>
            <p>Bu Ay Bakiye</p>
        </div>
    </div>
    
    <!-- Tarih & Saat Kartı -->
    <div class="datetime-card fade-in" style="animation-delay: 0.3s;">
        <div class="datetime-header">
            <div class="datetime-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="datetime-info">
                <div class="time" id="currentTime">{{ current_datetime.strftime('%H:%M:%S') }}</div>
                <div class="date" id="currentDate">{{ current_datetime.strftime('%d %B %Y') }}</div>
            </div>
        </div>
        
        <div class="timezone-select-wrapper">
            <div class="timezone-label">
                <i class="fas fa-globe"></i> Saat Dilimi
            </div>
            
            <button type="button" class="timezone-trigger" id="timezoneTrigger">
                {{ current_timezone.split('/')[1].replace('_', ' ') if '/' in current_timezone else current_timezone }}
            </button>
            
            <div class="timezone-dropdown" id="timezoneDropdown">
                <div class="timezone-search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="timezone-search" id="timezoneSearch" 
                           placeholder="Şehir ara..." autocomplete="off">
                </div>
                
                <div class="timezone-list" id="timezoneList">
                    {% for region, zones in timezones.items() %}
                        {% if zones %}
                        <div class="timezone-group" data-region="{{ region }}">
                            <div class="timezone-group-label">{{ region }}</div>
                            {% for zone in zones %}
                            <div class="timezone-option {% if zone.value == current_timezone %}selected{% endif %}" 
                                 data-value="{{ zone.value }}" 
                                 data-city="{{ zone.city }}"
                                 data-offset="{{ zone.offset }}">
                                <span>{{ zone.city }}</span>
                                <span class="offset">{{ zone.offset }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Grid -->
<div class="dashboard-grid">
    <!-- Son İşlemler -->
    <div class="card fade-in" style="animation-delay: 0.4s;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-clock-rotate-left" style="margin-right: 0.5rem; color: var(--primary-500);"></i>
                Son İşlemler
            </h3>
        </div>
        <div class="card-body">
            <ul class="transaction-list" id="sonIslemler">
                <li class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>Henüz işlem yok</h3>
                    <p>Gelir veya gider ekleyerek başlayın</p>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Özet Bilgiler -->
    <div class="card fade-in" style="animation-delay: 0.5s;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie" style="margin-right: 0.5rem; color: var(--primary-500);"></i>
                Genel Özet
            </h3>
        </div>
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <!-- Toplam Gelir -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gelir-bg); border-radius: var(--radius-lg);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-arrow-up" style="color: var(--gelir-color); font-size: 1.25rem;"></i>
                        <span style="font-weight: 600; color: var(--gray-700);">Toplam Gelir</span>
                    </div>
                    <span id="toplamGelir" class="money positive" style="font-size: 1.125rem;">0,00 ₺</span>
                </div>
                
                <!-- Toplam Gider -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gider-bg); border-radius: var(--radius-lg);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-arrow-down" style="color: var(--gider-color); font-size: 1.25rem;"></i>
                        <span style="font-weight: 600; color: var(--gray-700);">Toplam Gider</span>
                    </div>
                    <span id="toplamGider" class="money negative" style="font-size: 1.125rem;">0,00 ₺</span>
                </div>
                
                <!-- Net Bakiye -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: linear-gradient(135deg, var(--primary-50), var(--primary-100)); border-radius: var(--radius-lg); border: 2px solid var(--primary-200);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-scale-balanced" style="color: var(--primary-600); font-size: 1.5rem;"></i>
                        <span style="font-weight: 700; color: var(--gray-800); font-size: 1.1rem;">Net Bakiye</span>
                    </div>
                    <span id="toplamBakiye" class="money" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-700);">0,00 ₺</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Aylık ve Yıllık Gelir Tabloları -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
        <!-- Aylık Gelir Tablosu -->
        <div class="card fade-in" style="animation-delay: 0.6s;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-calendar-alt" style="margin-right: 0.5rem; color: var(--gelir-color);"></i>
                    Aylık Gelir Tablosu
                </h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Ay</th>
                                <th style="text-align: right;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="aylikGelirTablosu">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Yıllık Gelir Tablosu -->
        <div class="card fade-in" style="animation-delay: 0.7s;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem; color: var(--gelir-color);"></i>
                    Yıllık Gelir Tablosu
                </h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Yıl</th>
                                <th style="text-align: right;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="yillikGelirTablosu">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { Dashboard, Yardimci, Kategoriler } from '{{ url_for("static", filename="js/db.js") }}';
    import { setTimezone, getTimezone } from '{{ url_for("static", filename="js/i18n.js") }}';
    
    // Saat güncelleme
    function updateClock() {
        const now = new Date();
        const timezone = getTimezone();
        
        const timeOptions = { timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const dateOptions = { timeZone: timezone, day: 'numeric', month: 'long', year: 'numeric' };
        
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('tr-TR', timeOptions);
        document.getElementById('currentDate').textContent = now.toLocaleDateString('tr-TR', dateOptions);
    }
    
    setInterval(updateClock, 1000);
    updateClock();
    
    // Saat dilimi seçici
    const tzTrigger = document.getElementById('timezoneTrigger');
    const tzSearch = document.getElementById('timezoneSearch');
    const tzDropdown = document.getElementById('timezoneDropdown');
    const tzList = document.getElementById('timezoneList');
    const tzOptions = document.querySelectorAll('.timezone-option');
    const tzGroups = document.querySelectorAll('.timezone-group');
    
    // Trigger'a tıklandığında dropdown aç/kapat
    tzTrigger.addEventListener('click', () => {
        const isOpen = tzDropdown.classList.toggle('active');
        tzTrigger.classList.toggle('open', isOpen);
        
        if (isOpen) {
            tzSearch.value = '';
            tzSearch.focus();
            // Tüm seçenekleri göster
            tzGroups.forEach(g => g.style.display = 'block');
            tzOptions.forEach(o => o.style.display = 'flex');
        }
    });
    
    // Dışarı tıklandığında kapat
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.timezone-select-wrapper')) {
            tzDropdown.classList.remove('active');
            tzTrigger.classList.remove('open');
        }
    });
    
    // Arama filtresi
    tzSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        let hasResults = false;
        
        tzGroups.forEach(group => {
            let groupHasMatch = false;
            const options = group.querySelectorAll('.timezone-option');
            
            options.forEach(option => {
                const city = option.dataset.city.toLowerCase();
                const offset = option.dataset.offset.toLowerCase();
                const matches = city.includes(query) || offset.includes(query);
                
                option.style.display = matches ? 'flex' : 'none';
                if (matches) {
                    groupHasMatch = true;
                    hasResults = true;
                }
            });
            
            group.style.display = groupHasMatch ? 'block' : 'none';
        });
        
        // Sonuç yoksa mesaj göster
        let noResults = tzList.querySelector('.no-results');
        if (!hasResults) {
            if (!noResults) {
                noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.textContent = 'Sonuç bulunamadı';
                tzList.appendChild(noResults);
            }
            noResults.style.display = 'block';
        } else if (noResults) {
            noResults.style.display = 'none';
        }
    });
    
    // Seçim yapıldığında
    tzOptions.forEach(option => {
        option.addEventListener('click', function() {
            const value = this.dataset.value;
            const city = this.dataset.city;
            
            // Seçimi güncelle
            tzOptions.forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            
            // Trigger'ı güncelle
            tzTrigger.textContent = city;
            
            // Dropdown kapat
            tzDropdown.classList.remove('active');
            tzTrigger.classList.remove('open');
            
            // Saat dilimini kaydet
            setTimezone(value);
            updateClock();
        });
    });
    
    // Klavye kontrolleri
    tzSearch.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const visibleOptions = [...tzOptions].filter(o => o.style.display !== 'none');
            if (visibleOptions.length > 0) {
                visibleOptions[0].click();
            }
        } else if (e.key === 'Escape') {
            tzDropdown.classList.remove('active');
            tzTrigger.classList.remove('open');
        }
    });
    
    // Dashboard verilerini yükle
    async function loadDashboard() {
        const stats = await Dashboard.istatistikler();
        
        document.getElementById('aylikGelir').textContent = Yardimci.paraFormat(stats.aylik_gelir);
        document.getElementById('aylikGider').textContent = Yardimci.paraFormat(stats.aylik_gider);
        document.getElementById('aylikBakiye').textContent = Yardimci.paraFormat(stats.aylik_bakiye);
        
        document.getElementById('toplamGelir').textContent = Yardimci.paraFormat(stats.toplam_gelir);
        document.getElementById('toplamGider').textContent = Yardimci.paraFormat(stats.toplam_gider);
        document.getElementById('toplamBakiye').textContent = Yardimci.paraFormat(stats.toplam_bakiye);
        
        const bakiyeEl = document.getElementById('toplamBakiye');
        bakiyeEl.style.color = stats.toplam_bakiye >= 0 ? 'var(--gelir-color)' : 'var(--gider-color)';
        
        const sonIslemlerEl = document.getElementById('sonIslemler');
        
        if (stats.son_islemler.length === 0) {
            sonIslemlerEl.innerHTML = `
                <li class="empty-state" style="padding: 2rem;">
                    <div class="empty-state-icon" style="font-size: 3rem;">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>Henüz işlem yok</h3>
                    <p>Gelir veya gider ekleyerek başlayın</p>
                </li>
            `;
        } else {
            sonIslemlerEl.innerHTML = stats.son_islemler.map(islem => {
                const kategori = Yardimci.kategoriGetir(islem.tip, islem.kategori);
                const isGelir = islem.tip === 'gelir';
                
                return `
                    <li class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon ${islem.tip}">
                                <i class="fas ${kategori.icon}"></i>
                            </div>
                            <div class="transaction-details">
                                <h4>${islem.aciklama || kategori.ad}</h4>
                                <span>${Yardimci.tarihFormat(islem.tarih)} • ${kategori.ad}</span>
                            </div>
                        </div>
                        <span class="transaction-amount ${islem.tip}">
                            ${isGelir ? '+' : '-'}${Yardimci.paraFormat(islem.tutar)}
                        </span>
                    </li>
                `;
            }).join('');
        }
    }
    
    // Aylık ve yıllık tabloları yükle
    async function loadTablolar() {
        const [aylikTablo, yillikTablo] = await Promise.all([
            Dashboard.aylikGelirTablosu(),
            Dashboard.yillikGelirTablosu()
        ]);
        
        // Aylık tablo
        const aylikTbody = document.getElementById('aylikGelirTablosu');
        if (aylikTablo.length === 0) {
            aylikTbody.innerHTML = `
                <tr>
                    <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="display: block; font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        Henüz gelir kaydı yok
                    </td>
                </tr>
            `;
        } else {
            aylikTbody.innerHTML = aylikTablo.map(ay => `
                <tr>
                    <td>
                        <strong>${ay.ayKisa}</strong>
                        <span style="color: var(--gray-500); font-size: 0.85rem;">${ay.yil}</span>
                    </td>
                    <td style="text-align: right; font-weight: 600; color: var(--gelir-color);">
                        ${Yardimci.paraFormat(ay.tutar)}
                    </td>
                </tr>
            `).join('');
        }
        
        // Yıllık tablo
        const yillikTbody = document.getElementById('yillikGelirTablosu');
        if (yillikTablo.length === 0) {
            yillikTbody.innerHTML = `
                <tr>
                    <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="display: block; font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        Henüz gelir kaydı yok
                    </td>
                </tr>
            `;
        } else {
            yillikTbody.innerHTML = yillikTablo.map(yil => `
                <tr>
                    <td>
                        <strong style="font-size: 1.1rem;">${yil.yil}</strong>
                    </td>
                    <td style="text-align: right; font-weight: 700; color: var(--gelir-color); font-size: 1.1rem;">
                        ${Yardimci.paraFormat(yil.tutar)}
                    </td>
                </tr>
            `).join('');
        }
    }
    
    // Realtime dinle
    Dashboard.dinle(stats => {
        document.getElementById('aylikGelir').textContent = Yardimci.paraFormat(stats.aylik_gelir);
        document.getElementById('aylikGider').textContent = Yardimci.paraFormat(stats.aylik_gider);
        document.getElementById('aylikBakiye').textContent = Yardimci.paraFormat(stats.aylik_bakiye);
        document.getElementById('toplamGelir').textContent = Yardimci.paraFormat(stats.toplam_gelir);
        document.getElementById('toplamGider').textContent = Yardimci.paraFormat(stats.toplam_gider);
        document.getElementById('toplamBakiye').textContent = Yardimci.paraFormat(stats.toplam_bakiye);
        
        // Tabloları da güncelle
        loadTablolar();
    });
    
    loadDashboard();
    loadTablolar();
</script>
{% endblock %}
