{% extends 'base.html' %}

{% block title %}Dashboard - Kişisel Muhasebe{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Finansal durumunuza genel bakış{% endblock %}

{% block header_actions %}
<a href="{{ url_for('gelirler.ekle') }}" class="btn btn-primary">
    <i class="fas fa-plus"></i> Gelir Ekle
</a>
<a href="{{ url_for('giderler.ekle') }}" class="btn btn-danger">
    <i class="fas fa-minus"></i> Gider Ekle
</a>
{% endblock %}

{% block extra_css %}
<style>
    .datetime-card {
        background: white;
        border-radius: var(--radius-xl);
        padding: 1.25rem 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid var(--gray-100);
    }
    .datetime-header {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .datetime-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    .datetime-info .time {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-800);
        letter-spacing: 0.02em;
    }
    .datetime-info .date {
        font-size: 0.85rem;
        color: var(--gray-500);
        margin-top: 0.15rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- İstatistik Kartları -->
<div class="dashboard-stats" id="statsContainer">
    <div class="stat-card gelir fade-in">
        <div class="stat-icon green">
            <i class="fas fa-arrow-trend-up"></i>
        </div>
        <div class="stat-content">
            <h3 id="aylikGelir">0,00 ₺</h3>
            <p>Bu Ay Gelir</p>
        </div>
    </div>
    
    <div class="stat-card gider fade-in" style="animation-delay: 0.1s;">
        <div class="stat-icon red">
            <i class="fas fa-arrow-trend-down"></i>
        </div>
        <div class="stat-content">
            <h3 id="aylikGider">0,00 ₺</h3>
            <p>Bu Ay Gider</p>
        </div>
    </div>
    
    <div class="stat-card bakiye fade-in" style="animation-delay: 0.2s;">
        <div class="stat-icon blue">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-content">
            <h3 id="aylikBakiye">0,00 ₺</h3>
            <p>Bu Ay Bakiye</p>
        </div>
    </div>
    
    <!-- Tarih & Saat (Europe/Istanbul) -->
    <div class="datetime-card fade-in" style="animation-delay: 0.3s;">
        <div class="datetime-header">
            <div class="datetime-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="datetime-info">
                <div class="time" id="currentTime">{{ current_datetime.strftime('%H:%M:%S') }}</div>
                <div class="date" id="currentDate">{{ current_datetime.strftime('%d %B %Y') }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Grid -->
<div class="dashboard-grid">
    <!-- Son İşlemler -->
    <div class="card fade-in" style="animation-delay: 0.4s;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-clock-rotate-left" style="margin-right: 0.5rem; color: var(--primary-500);"></i>
                Son İşlemler
            </h3>
        </div>
        <div class="card-body">
            <ul class="transaction-list" id="sonIslemler">
                <li class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>Henüz işlem yok</h3>
                    <p>Gelir veya gider ekleyerek başlayın</p>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Özet Bilgiler -->
    <div class="card fade-in" style="animation-delay: 0.5s;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie" style="margin-right: 0.5rem; color: var(--primary-500);"></i>
                Genel Özet
            </h3>
        </div>
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <!-- Toplam Gelir -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gelir-bg); border-radius: var(--radius-lg);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-arrow-up" style="color: var(--gelir-color); font-size: 1.25rem;"></i>
                        <span style="font-weight: 600; color: var(--gray-700);">Toplam Gelir</span>
                    </div>
                    <span id="toplamGelir" class="money positive" style="font-size: 1.125rem;">0,00 ₺</span>
                </div>
                
                <!-- Toplam Gider -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gider-bg); border-radius: var(--radius-lg);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-arrow-down" style="color: var(--gider-color); font-size: 1.25rem;"></i>
                        <span style="font-weight: 600; color: var(--gray-700);">Toplam Gider</span>
                    </div>
                    <span id="toplamGider" class="money negative" style="font-size: 1.125rem;">0,00 ₺</span>
                </div>
                
                <!-- Net Bakiye -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: linear-gradient(135deg, var(--primary-50), var(--primary-100)); border-radius: var(--radius-lg); border: 2px solid var(--primary-200);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-scale-balanced" style="color: var(--primary-600); font-size: 1.5rem;"></i>
                        <span style="font-weight: 700; color: var(--gray-800); font-size: 1.1rem;">Net Bakiye</span>
                    </div>
                    <span id="toplamBakiye" class="money" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-700);">0,00 ₺</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Aylık ve Yıllık Gelir Tabloları -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
        <!-- Aylık Gelir Tablosu -->
        <div class="card fade-in" style="animation-delay: 0.6s;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-calendar-alt" style="margin-right: 0.5rem; color: var(--gelir-color);"></i>
                    Aylık Gelir Tablosu
                </h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Ay</th>
                                <th style="text-align: right;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="aylikGelirTablosu">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Yıllık Gelir Tablosu -->
        <div class="card fade-in" style="animation-delay: 0.7s;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem; color: var(--gelir-color);"></i>
                    Yıllık Gelir Tablosu
                </h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Yıl</th>
                                <th style="text-align: right;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="yillikGelirTablosu">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { Dashboard, Yardimci, Kategoriler } from '{{ url_for("static", filename="js/db.js") }}';
    
    const TZ = 'Europe/Istanbul';
    function updateClock() {
        const now = new Date();
        const timeOpt = { timeZone: TZ, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        const dateOpt = { timeZone: TZ, day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('tr-TR', timeOpt);
        document.getElementById('currentDate').textContent = now.toLocaleDateString('tr-TR', dateOpt);
    }
    setInterval(updateClock, 1000);
    updateClock();
    
    // Dashboard verilerini yükle
    async function loadDashboard() {
        const stats = await Dashboard.istatistikler();
        
        document.getElementById('aylikGelir').textContent = Yardimci.paraFormat(stats.aylik_gelir);
        document.getElementById('aylikGider').textContent = Yardimci.paraFormat(stats.aylik_gider);
        document.getElementById('aylikBakiye').textContent = Yardimci.paraFormat(stats.aylik_bakiye);
        
        document.getElementById('toplamGelir').textContent = Yardimci.paraFormat(stats.toplam_gelir);
        document.getElementById('toplamGider').textContent = Yardimci.paraFormat(stats.toplam_gider);
        document.getElementById('toplamBakiye').textContent = Yardimci.paraFormat(stats.toplam_bakiye);
        
        const bakiyeEl = document.getElementById('toplamBakiye');
        bakiyeEl.style.color = stats.toplam_bakiye >= 0 ? 'var(--gelir-color)' : 'var(--gider-color)';
        
        const sonIslemlerEl = document.getElementById('sonIslemler');
        
        if (stats.son_islemler.length === 0) {
            sonIslemlerEl.innerHTML = `
                <li class="empty-state" style="padding: 2rem;">
                    <div class="empty-state-icon" style="font-size: 3rem;">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>Henüz işlem yok</h3>
                    <p>Gelir veya gider ekleyerek başlayın</p>
                </li>
            `;
        } else {
            sonIslemlerEl.innerHTML = stats.son_islemler.map(islem => {
                const kategori = Yardimci.kategoriGetir(islem.tip, islem.kategori);
                const isGelir = islem.tip === 'gelir';
                
                return `
                    <li class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon ${islem.tip}">
                                <i class="fas ${kategori.icon}"></i>
                            </div>
                            <div class="transaction-details">
                                <h4>${islem.aciklama || kategori.ad}</h4>
                                <span>${Yardimci.tarihFormat(islem.tarih)} • ${kategori.ad}</span>
                            </div>
                        </div>
                        <span class="transaction-amount ${islem.tip}">
                            ${isGelir ? '+' : '-'}${Yardimci.paraFormat(islem.tutar)}
                        </span>
                    </li>
                `;
            }).join('');
        }
    }
    
    // Aylık ve yıllık tabloları yükle
    async function loadTablolar() {
        const [aylikTablo, yillikTablo] = await Promise.all([
            Dashboard.aylikGelirTablosu(),
            Dashboard.yillikGelirTablosu()
        ]);
        
        // Aylık tablo
        const aylikTbody = document.getElementById('aylikGelirTablosu');
        if (aylikTablo.length === 0) {
            aylikTbody.innerHTML = `
                <tr>
                    <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="display: block; font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        Henüz gelir kaydı yok
                    </td>
                </tr>
            `;
        } else {
            aylikTbody.innerHTML = aylikTablo.map(ay => `
                <tr>
                    <td>
                        <strong>${ay.ayKisa}</strong>
                        <span style="color: var(--gray-500); font-size: 0.85rem;">${ay.yil}</span>
                    </td>
                    <td style="text-align: right; font-weight: 600; color: var(--gelir-color);">
                        ${Yardimci.paraFormat(ay.tutar)}
                    </td>
                </tr>
            `).join('');
        }
        
        // Yıllık tablo
        const yillikTbody = document.getElementById('yillikGelirTablosu');
        if (yillikTablo.length === 0) {
            yillikTbody.innerHTML = `
                <tr>
                    <td colspan="2" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-inbox" style="display: block; font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        Henüz gelir kaydı yok
                    </td>
                </tr>
            `;
        } else {
            yillikTbody.innerHTML = yillikTablo.map(yil => `
                <tr>
                    <td>
                        <strong style="font-size: 1.1rem;">${yil.yil}</strong>
                    </td>
                    <td style="text-align: right; font-weight: 700; color: var(--gelir-color); font-size: 1.1rem;">
                        ${Yardimci.paraFormat(yil.tutar)}
                    </td>
                </tr>
            `).join('');
        }
    }
    
    // Realtime dinle
    Dashboard.dinle(stats => {
        document.getElementById('aylikGelir').textContent = Yardimci.paraFormat(stats.aylik_gelir);
        document.getElementById('aylikGider').textContent = Yardimci.paraFormat(stats.aylik_gider);
        document.getElementById('aylikBakiye').textContent = Yardimci.paraFormat(stats.aylik_bakiye);
        document.getElementById('toplamGelir').textContent = Yardimci.paraFormat(stats.toplam_gelir);
        document.getElementById('toplamGider').textContent = Yardimci.paraFormat(stats.toplam_gider);
        document.getElementById('toplamBakiye').textContent = Yardimci.paraFormat(stats.toplam_bakiye);
        
        // Tabloları da güncelle
        loadTablolar();
    });
    
    loadDashboard();
    loadTablolar();
</script>
{% endblock %}
